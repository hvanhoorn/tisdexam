%
% Format for producing master card for multiple choice exams
% at The Hague University of Applied Sciences.
%
% (c)2013, J. op den Brouw <J.E.J.opdenBrouw@hhs.nl>
%
% This format is for producing the 100 question / 5 answers
% variant, both Dutch and English versions.
%
% Tip: you should know a bit about \LaTex
%

%% Get the answers generated by the exam...
\IfFileExists{answers.ans}{\input{answers.ans}}
 {\GenericError{}{!!! Answers file is missing! Please rerun the exam! !!!}{You should run the exam file! } \stop}

%%%% User commands end here %%%%

%% Document Class is Article
\documentclass[a4paper,11pt]{article}

%% PDF Version and compression...
\pdfminorversion=5
\pdfobjcompresslevel=2

%% Use Helvitica instead of Times
\usepackage[scaled]{helvet}
\renewcommand*\familydefault{\sfdefault}
\usepackage[T1]{fontenc}

%% Use set spacing
\usepackage{setspace}

%% Use the Xstring package for \StrRight, \StrGobbleRight, \StrChar, \IfStrEq
\usepackage{xstring}

%% Use package Pdgfor for foreach looping
\usepackage{pgffor}

%% Include (PDF) graphics files
\usepackage{graphicx}

%% Do caculations on lengths and counters
\usepackage{calc}

%% Use colors
\usepackage[usenames]{color}

%% Better floats of figures
\usepackage{float}

%% Using hyperrefs...
\usepackage{hyperref}
\hypersetup{
	colorlinks=false,
	linkcolor=blue,
	pdftitle={\examusername\ \examcoursename},    % title
	pdfauthor={\examcreatorname},     % author
	pdfsubject={},   % subject of the document
	pdfcreator={Mastercard Generator v1.2alpha (20131016)
	},   % creator of the document
	%pdfproducer={PDFtoLaTex}, % producer of the document
	pdfkeywords={\examusername\ \examcoursename\ \examdate}  % list of keywords
}

%% Use (absolute) text positioning
\usepackage[absolute]{textpos}
\setlength{\TPHorizModule}{0.01pt}
\setlength{\TPVertModule}{\TPHorizModule}
\textblockorigin{0mm}{0mm} % start everything at the top-left corner
\setlength{\parindent}{0pt}
\pagestyle{empty}

%% \setlength and \addtolength are locally scoped
%% Global \setlength
\newcommand*{\gsetlength}[2]{%
	\setlength{#1}{#2}%
	\global#1=#1\relax
}
%% Global \addtolength
\newcommand*{\gaddtolength}[2]{%
  \addtolength{#1}{#2}%
  \global#1=#1\relax
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               %%
%% The beginning of the document %%
%%                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Include the Sonate 100-question / 5-choices File %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\IfStrEq{\examenglish}{yes}{\global\def\sourcefile{engels}}{\global\def\sourcefile{nl}}
\IfStrEq{\examenglish}{yes}{\global\def\useenglish{}}{}
\begin{textblock*}{597.4pt}(0pt,0pt)
	\begin{figure}[H]
  		\centering
  		\includegraphics{vijfkeuze_\sourcefile.pdf}
	\end{figure}
\end{textblock*}

%%%%%%%%%%%%%%%%%%%%%%%
%%      Answers      %%
%%%%%%%%%%%%%%%%%%%%%%%
%% Plots the answers on the right spot

%% Define the X and Y positions, item number (for warnings)
\newlength{\xoffset}
\newlength{\yoffset}
\newcounter{itemnumber}
\newcounter{yincr}
\setcounter{itemnumber}{0}
\setcounter{yincr}{0}

% Loop all items in \aq
\foreach \x in \examaq {
	% Correct answer is last token of item, placed in \myanws
	\StrRight{\x}{1}[\myansw]
	% Question number is left of correct answer, placed in \mynumb
	\StrGobbleRight{\x}{1}[\mynumb]
	\addtocounter{itemnumber}{1}
	%% Calculate the X offset origin (one of three offsets}
	\ifnum \mynumb>100 {\color{red}*** Error: list entry \#\arabic{itemnumber} question  number too high ***} \else
		\ifnum \mynumb>80 \gsetlength{\xoffset}{438.45pt} \else
			\ifnum \mynumb>40 \gsetlength{\xoffset}{250.55pt} \else
				\ifnum \mynumb>0 \gsetlength{\xoffset}{059.75pt} \else
					{\color{red}*** Error: list entry \#\arabic{itemnumber} question number too low ***}
				\fi
			\fi
		\fi
	\fi
	
	%% Calculate the X offset towards the answers
	\if A\myansw \gaddtolength{\xoffset}{0pt} \else
		\if B\myansw \gaddtolength{\xoffset}{26.85pt} \else
			\if C\myansw \gaddtolength{\xoffset}{53.80pt} \else
				\if D\myansw \gaddtolength{\xoffset}{81.05pt} \else
					\if E\myansw \gaddtolength{\xoffset}{108.20pt} \else
						{\color{red}*** Error: list entry \#\arabic{itemnumber} invalid answer ***}\nolinebreak
					\fi
				\fi
			\fi
		\fi
	\fi
	
	%% Calculate the Y offset origin, we use \null-s because we already printed warnings...
	\setcounter{yincr}{\mynumb}
	\ifnum \mynumb>100 \null{} \else
		\ifnum \mynumb>80 \gsetlength{\yoffset}{449.58pt}\addtocounter{yincr}{-81} \else
			\ifnum \mynumb>60 \gsetlength{\yoffset}{449.58pt}\addtocounter{yincr}{-61} \else
				\ifnum \mynumb>40 \gsetlength{\yoffset}{156.24pt}\addtocounter{yincr}{-41} \else
					\ifnum \mynumb>20 \gsetlength{\yoffset}{449.58pt} \addtocounter{yincr}{-21}\else
						\ifnum \mynumb>0 \gsetlength{\yoffset}{156.24pt} \addtocounter{yincr}{-1}\else
							\null{}
						 \fi
					\fi
				\fi
			\fi
		\fi
	\fi
	
	%% Set the Y offset to the right value
	\gaddtolength{\yoffset}{14.24pt*\value{yincr}}
	
	%% Plot the box
	\begin{textblock*}{10pt}(\xoffset,\yoffset)\rule[0mm]{3.28mm}{2.09mm}\end{textblock*}
	%\begin{textblock*}{10pt}(\xoffset,\yoffset){\color{cyan}\rule[0mm]{3.28mm}{2.09mm}}\end{textblock*}
}

%%%%%%%%%%%%%%%%%%%%%%%
%%        Naam       %%
%%%%%%%%%%%%%%%%%%%%%%%
%% Prints "Mastercard"
\begin{textblock*}{420pt}(28.5pt,80.0pt)
\newcounter{count}
\setcounter{count}{0}
\loop\unless\ifnum\value{count}=24
  \stepcounter{count}%
  \makebox[17.35pt][c]{\LARGE{\StrChar{\examusername}{\value{count}}}}%
\repeat
\end{textblock*}

%%%%%%%%%%%%%%%%%%%%%%%
%%     Tentamen      %%
%%%%%%%%%%%%%%%%%%%%%%%
%% Prints the name of the exam
\begin{textblock*}{400pt}(28.5pt,117.0pt)
\setcounter{count}{0}
\loop\unless\ifnum\value{count}=23
  \stepcounter{count}%
  \makebox[16.62pt][c]{\LARGE{\StrChar{\examcoursename}{\value{count}}}}%
\repeat
\end{textblock*}

%%%%%%%%%%%%%%%%%%%%%%%
%%   Gemaakt door    %%
%%%%%%%%%%%%%%%%%%%%%%%
%% Prints the name of creator
\begin{textblock*}{180pt}(400.0pt,340.0pt)
\centering\large{\examcreatorname}
\vspace*{\fill}
\end{textblock*}

%%%%%%%%%%%%%%%%%%%%%%%
%%      The date     %%
%%%%%%%%%%%%%%%%%%%%%%%
%% Day of the month
\begin{textblock*}{10pt}(429.9pt,111.5pt)\LARGE{\StrChar{\examdate}{1}}\end{textblock*}
\begin{textblock*}{10pt}(443.9pt,111.5pt)\LARGE{\StrChar{\examdate}{2}}\end{textblock*}
%% Month in numbers
\begin{textblock*}{10pt}(471.9pt,111.5pt)\LARGE{\StrChar{\examdate}{4}}\end{textblock*}
\begin{textblock*}{10pt}(485.9pt,111.5pt)\LARGE{\StrChar{\examdate}{5}}\end{textblock*}
%% Year mod 100
\begin{textblock*}{10pt}(543.0pt,111.5pt)\LARGE{\StrChar{\examdate}{9}}\end{textblock*}
\begin{textblock*}{10pt}(557.0pt,111.5pt)\LARGE{\StrChar{\examdate}{10}}\end{textblock*}

%%%%%%%%%%%%%%%%%%%%%%%
%%   StudentNummer   %%
%%%%%%%%%%%%%%%%%%%%%%%
% Write the Student Number, must be exactly 8 decimal digits
% These two routines should be implemented as one...
\begin{textblock*}{400pt}(436.50pt,161.50pt)
\setcounter{count}{0}
\loop\unless\ifnum\value{count}=8%
  \stepcounter{count}%
  \StrChar{\examstudentnumber}{\value{count}}[\neededchar]%
  \makebox[15.35pt][c]{\LARGE{\neededchar}}%
\repeat
\end{textblock*}%
% Write the squares that make up the Student Number
\gsetlength{\xoffset}{439.00pt}%
\setcounter{count}{0}%
\loop\unless\ifnum\value{count}=8%
  \stepcounter{count}%
  \StrChar{\examstudentnumber}{\value{count}}[\neededchar]%
  \IfInteger{\neededchar}{%
    \gsetlength{\yoffset}{181.00pt}%
  	\gaddtolength{\yoffset}{11.58pt*\neededchar}%
  	\begin{textblock*}{10pt}(\xoffset,\yoffset)\rule[0mm]{2.7mm}{2.71mm}\end{textblock*}%
  }{\color{red}*** Error: character \#\arabic{count} of Student Number is not a decimal digit ***\par}%
  \gaddtolength{\xoffset}{15.75pt}%
\repeat


%%%%%%%%%%%%%%%%%%%%%%%
%%       Versie      %%
%%%%%%%%%%%%%%%%%%%%%%%
% Version, one of A, B, C or D
% This could be done smarter...
\ifx \useenglish \undefined
	% A
	\if A\examversion \begin{textblock*}{10pt}(059.85pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
	% B
	\if B\examversion \begin{textblock*}{10pt}(095.30pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
	% C
	\if C\examversion \begin{textblock*}{10pt}(130.80pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
	% D
	\if D\examversion \begin{textblock*}{10pt}(166.80pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
\else
	% A
	\if A\examversion \begin{textblock*}{10pt}(064.20pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
	% B
	\if B\examversion \begin{textblock*}{10pt}(099.65pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
	% C
	\if C\examversion \begin{textblock*}{10pt}(135.15pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
	% D
	\if D\examversion \begin{textblock*}{10pt}(171.15pt,139.30pt)\rule[0mm]{3.30mm}{2.10mm}\end{textblock*} \fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%
%%    Opmerkingen    %%
%%%%%%%%%%%%%%%%%%%%%%%
% Comment on maximum of three lines...
\begin{textblock*}{380pt}(70pt,758pt)
\begin{spacing}{1.2000}
\Large{\examcomment}
\end{spacing}
\end{textblock*}

\end{document}